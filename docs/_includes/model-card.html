<link rel="stylesheet" href="{{ '/assets/css/cards.css' | relative_url }}">
<link rel="stylesheet" href="{{ '/assets/css/model.css' | relative_url }}">

<script>
  (function(){
    if (window.__t2_model_viewer_loaded) return;
    window.__t2_model_viewer_loaded = true;
    const s = document.createElement('script');
    s.type = 'module';
    s.src = 'https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js';
    document.head.appendChild(s);
  })();
</script>

<div class="t2-card">
  {% if include.title %}
    <h2 style="margin-bottom:10px;">{{ include.title }}</h2>
  {% endif %}

  <div class="t2-model-stage">
    <model-viewer
      class="t2-model-viewer"
      src="{{ include.file | relative_url }}"
      {% if include.poster %}poster="{{ include.poster | relative_url }}"{% endif %}
      alt="{{ include.alt | default: '3D model' }}"
      camera-controls
      auto-rotate
      rotation-per-second="12deg"
      interaction-prompt="auto"

      environment-image="neutral"
      exposure="1.05"
      shadow-intensity="1.1"
      shadow-softness="0.6">
    </model-viewer>
  </div>

  {% if include.caption %}
    <div class="t2-model-caption">{{ include.caption }}</div>
  {% endif %}
</div>

{% if include.force_gray == "true" %}
<script type="module">
  // Force a significantly darker gray for all materials.
  // If you want to avoid touching textured materials, uncomment the "if (pbr.baseColorTexture) continue;" line.
  const card = document.currentScript.previousElementSibling;
  const mv = card?.querySelector?.('model-viewer');

  if (mv) {
    mv.addEventListener('load', () => {
      try {
        const model = mv.model;
        if (!model) return;

        // Dark neutral gray (try 0.18â€“0.30 range)
        const DARK = [0.22, 0.22, 0.22, 1.0];

        for (const mat of model.materials) {
          const pbr = mat.pbrMetallicRoughness;
          if (!pbr) continue;

          // If you DON'T want to darken textured materials, use this:
          // if (pbr.baseColorTexture) continue;

          pbr.setBaseColorFactor(DARK);

          // Keep it matte so lighting reads nicely (less "white plastic" look)
          pbr.setMetallicFactor(0.0);
          pbr.setRoughnessFactor(1.0);
        }
      } catch (e) {
        // no-op if scene-graph API isn't available
      }
    });
  }
</script>
{% endif %}
