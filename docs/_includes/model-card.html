<link rel="stylesheet" href="{{ '/assets/css/cards.css' | relative_url }}">
<link rel="stylesheet" href="{{ '/assets/css/model.css' | relative_url }}">

<script type="module">
  // Load model-viewer once (official CDN). This avoids older/broken builds.
  if (!window.__t2_model_viewer_loaded) {
    window.__t2_model_viewer_loaded = true;
    import('https://cdn.jsdelivr.net/npm/@google/model-viewer/dist/model-viewer.min.js');
  }
</script>

<div class="t2-card">
  {% if include.title %}
    <h2 style="margin-bottom:10px;">{{ include.title }}</h2>
  {% endif %}

  <div class="t2-model-stage">
    <model-viewer
      class="t2-model-viewer {% if include.force_gray == 'true' %}t2-model-darken{% endif %}"
      src="{{ include.file | relative_url }}"
      {% if include.poster %}poster="{{ include.poster | relative_url }}"{% endif %}
      alt="{{ include.alt | default: '3D model' }}"
      camera-controls
      auto-rotate
      rotation-per-second="12deg"
      interaction-prompt="auto"
      environment-image="neutral"
      exposure="1.0"
      shadow-intensity="1.1"
      shadow-softness="0.6">
    </model-viewer>
  </div>

  {% if include.caption %}
    <div class="t2-model-caption">{{ include.caption }}</div>
  {% endif %}
</div>

{% if include.force_gray == "true" %}
<script type="module">
  // Try to force materials darker via scene-graph API.
  // If that API isn't available, CSS filter still darkens it (see t2-model-darken class).
  const card = document.currentScript.previousElementSibling;
  const mv = card?.querySelector?.('model-viewer');
  if (!mv) return;

  await customElements.whenDefined('model-viewer');

  function tryDarkenMaterials() {
    const model = mv.model;
    if (!model || !model.materials) return false;

    const DARK = [0.15, 0.15, 0.15, 1.0]; // very dark gray

    for (const mat of model.materials) {
      const pbr = mat.pbrMetallicRoughness;
      if (!pbr) continue;

      // If you want to keep textures, uncomment:
      // if (pbr.baseColorTexture) continue;

      pbr.setBaseColorFactor(DARK);
      pbr.setMetallicFactor(0.0);
      pbr.setRoughnessFactor(1.0);
    }
    return true;
  }

  // Run after model load; also retry once after a short delay (helps some builds).
  mv.addEventListener('load', () => {
    const ok = tryDarkenMaterials();
    // If ok=false, CSS filter will still make it darker, so nothing else needed.
    if (!ok) {
      // Optional: uncomment to debug in browser console
      // console.log("model-viewer scene-graph not available; using CSS darken fallback");
    } else {
      // If scene-graph succeeded, we can reduce CSS filter strength slightly:
      mv.classList.add('t2-model-darken-soft');
    }
  });

  setTimeout(() => { tryDarkenMaterials(); }, 500);
</script>
{% endif %}
